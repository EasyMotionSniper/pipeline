è¿™æ˜¯ä¸ªå¾ˆæ£’çš„é—®é¢˜ã€‚Quake III Arena çš„ç½‘ç»œç³»ç»Ÿæ˜¯ FPS ç½‘ç»œè®¾è®¡çš„ç»å…¸èŒƒå¼ä¹‹ä¸€ï¼ŒJohn Carmack çš„â€œClient-Server + Snapshot + Delta Compressionâ€æ¨¡å¼å½±å“äº†åæ¥ä¸€å¤§æ‰¹æ¸¸æˆã€‚

---

## ğŸ¯ ç›®æ ‡ï¼šå¦‚ä½•é«˜æ•ˆé˜…è¯» Quake 3 çš„ç½‘ç»œä»£ç ï¼Ÿ

æˆ‘ä»¬æŠŠç›®æ ‡æ‹†æˆä¸‰æ­¥èµ°ï¼š

1. **å…ˆæ•´ä½“ç†è§£ Quake 3 çš„ç½‘ç»œæ¶æ„è®¾è®¡æ€è·¯**
2. **çŸ¥é“ä»£ç åœ¨å“ªäº›æ–‡ä»¶ä¸­**
3. **å¸¦ç€é—®é¢˜å»è¯»ï¼Œå¾ªåºæ¸è¿›**

---

## ğŸ§­ Step 1ï¼šå…ˆæ•´ä½“æŠŠæ¡ Quake 3 çš„ç½‘ç»œæ¶æ„è®¾è®¡

é˜…è¯»æºç å‰ï¼Œä½ è¦çŸ¥é“å®ƒæ˜¯æ€ä¹ˆè®¾è®¡çš„ï¼Œè¿™æ ·ä½ æ‰çŸ¥é“â€œæˆ‘åœ¨æ‰¾ä»€ä¹ˆâ€ã€‚

### æ ¸å¿ƒæ¦‚å¿µï¼ˆå…ˆææ‡‚ï¼‰ï¼š

| æ¦‚å¿µ                    | è¯´æ˜                                                      |
| --------------------- | ------------------------------------------------------- |
| Clientâ€“Server         | Quake 3 æ˜¯ä¸¥æ ¼çš„æœåŠ¡å™¨æƒå¨æ¨¡å‹ã€‚å®¢æˆ·ç«¯åªè´Ÿè´£è¾“å…¥ï¼Œæ‰€æœ‰æ¸¸æˆé€»è¾‘åœ¨æœåŠ¡å™¨ä¸Šå†³å®šã€‚             |
| Snapshot              | æœåŠ¡å™¨æ¯å¸§å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª snapshotï¼ˆå½“å‰æ¸¸æˆçŠ¶æ€çš„å¿«ç…§ï¼‰ï¼Œå®¢æˆ·ç«¯åªæ¸²æŸ“è¿™äº›å¿«ç…§ã€‚           |
| Delta Compression     | ä¸ºäº†çœå¸¦å®½ï¼Œsnapshot æ˜¯åŸºäºå‰ä¸€ä¸ª snapshot åšçš„ deltaã€‚                |
| Reliable / Unreliable | Quake 3 çš„ç½‘ç»œå±‚æœ‰ä¸€ä¸ªè‡ªå·±å®ç°çš„å¯é æ¶ˆæ¯é€šé“ï¼ˆreliable channelï¼‰ï¼Œæ¯” TCP æ›´è½»é‡ã€‚ |
| Sequencing            | åŒ…å«åºåˆ—å·ã€ackã€ä¸¢åŒ…æ£€æµ‹ç­‰æœºåˆ¶ã€‚                                      |

---

## ğŸ—‚ Step 2ï¼šæ‰¾å¯¹ä»£ç æ–‡ä»¶

Quake 3 çš„æºä»£ç ç»“æ„æ¸…æ™°ï¼Œå¤§éƒ¨åˆ†ç½‘ç»œç›¸å…³é€»è¾‘é›†ä¸­åœ¨è¿™äº›æ–‡ä»¶ï¼š

| æ–‡ä»¶è·¯å¾„                        | åŠŸèƒ½                                                    |
| --------------------------- | ----------------------------------------------------- |
| `code/qcommon/net_chan.c`   | ç½‘ç»œä¼ è¾“å±‚ï¼ˆNetChanï¼‰ï¼Œè´Ÿè´£å°è£… UDP åŒ…ã€åŠ ä¸Šåºåˆ—å·ã€é‡å‘ã€å¯é é€šé“ã€‚*å¿…çœ‹æ–‡ä»¶*        |
| `code/qcommon/msg.c`        | æ¶ˆæ¯è¯»å†™å°è£…ï¼ˆè¯»å†™ int/float/stringï¼‰ï¼Œæ‰“åŒ…ç”¨ã€‚                      |
| `code/qcommon/cm_*.c`       | Collision modelï¼Œä½†åœ¨ snapshot é‡Œæœ‰å¼•ç”¨ï¼Œäº†è§£ä½ç½®ç”¨é€”å³å¯ã€‚            |
| `code/qcommon/snapshots.c`  | Snapshot delta ç¼–è§£ç é€»è¾‘ï¼ˆserver æ‰“åŒ… snapshot / client è§£ç ï¼‰ã€‚ |
| `code/server/sv_snapshot.c` | æœåŠ¡å™¨ç«¯ç”Ÿæˆ snapshot çš„æ ¸å¿ƒé€»è¾‘ã€‚*é‡ç‚¹*                            |
| `code/server/sv_main.c`     | Server ä¸»å¾ªç¯ï¼Œè°ƒç”¨ snapshotã€å¤„ç†å®¢æˆ·ç«¯è¾“å…¥ã€‚                       |
| `code/server/sv_client.c`   | Server ç«¯çš„ client çŠ¶æ€ç®¡ç†ã€reliable message å‘é€ã€‚            |
| `code/client/cl_main.c`     | Client ä¸»å¾ªç¯ã€‚                                           |
| `code/client/cl_net.c`      | å®¢æˆ·ç«¯ç½‘ç»œæ”¶å‘ã€snapshot è§£åŒ…ã€‚                                  |
| `code/client/cl_parse.c`    | è§£æ snapshot å’Œ server commandã€‚                         |
| `code/client/cl_cgame.c`    | æŠŠ snapshot æ•°æ®äº¤ç»™æ¸²æŸ“å±‚ã€‚                                   |

---

## ğŸ“Œ Step 3ï¼šæ¨èé˜…è¯»é¡ºåº

> ä½ å¯ä»¥å¸¦ç€â€œæ•°æ®æµæ˜¯æ€ä¹ˆæµåŠ¨çš„ï¼Ÿâ€è¿™ä¸ªé—®é¢˜æ¥é˜…è¯»ã€‚

### æ¨èé¡ºåºï¼š

#### 1ï¸âƒ£ `net_chan.c`

**å…ˆçœ‹è¿™ä¸ªï¼Œç†è§£ UDP + å¯é é€šé“å®ç°ï¼š**

* `Netchan_Transmit()` / `Netchan_Process()`
* `Netchan_TransmitNextFragment()`
* `Netchan_Process()` æ˜¯å¦‚ä½•å¤„ç†åˆ†ç‰‡ã€ä¸¢åŒ…ã€é‡å‘çš„ã€‚

#### 2ï¸âƒ£ `msg.c`

**è¿™æ˜¯åº•å±‚è¯»å†™ bitstream çš„å°è£…ï¼š**

* `MSG_WriteByte/Long/Delta*`
* `MSG_Read*` ç³»åˆ—

#### 3ï¸âƒ£ `sv_snapshot.c` + `sv_client.c`

**æœåŠ¡å™¨ç«¯ snapshot ç”Ÿæˆ + å‘é€ï¼š**

* `SV_SendClientSnapshot()`
* `SV_WriteSnapshotToClient()`
* è§‚å¯Ÿå¦‚ä½• delta ç¼–ç  + ä½¿ç”¨ reliable channel

#### 4ï¸âƒ£ `cl_parse.c` + `cl_net.c`

**å®¢æˆ·ç«¯ snapshot è§£ç  + çŠ¶æ€æ›´æ–°ï¼š**

* `CL_ParseServerMessage()`
* `CL_ParseSnapshot()`
* çœ‹ delta å¦‚ä½•åº”ç”¨åœ¨å®¢æˆ·ç«¯ä¾§

#### 5ï¸âƒ£ `cl_cgame.c`

**å®¢æˆ·ç«¯å¦‚ä½•æŠŠ snapshot è½¬ä¸ºæ¸²æŸ“å±‚æ•°æ®ï¼š**

* `CL_SetCGameTime()`
* `CL_GetSnapshot()`
* å¸®åŠ©ä½ ç†è§£ prediction

---

## ğŸ§  é˜…è¯»æŠ€å·§

* ä» **ç½‘ç»œæ•°æ®åŒ…çš„ç”Ÿå‘½å‘¨æœŸ** å…¥æ‰‹ï¼š

  1. å®¢æˆ·ç«¯è¾“å…¥ â†’ `CL_SendCmd()`
  2. Server æ”¶åˆ° â†’ `SV_ExecuteClientCommand()`
  3. Server å‘ snapshot â†’ `SV_SendClientSnapshot()`
  4. Client æ”¶åˆ° snapshot â†’ `CL_ParseSnapshot()`
* ç”¨ `grep` / `rg`ï¼ˆripgrepï¼‰å¿«é€ŸæŸ¥æ‰¾ `Netchan_`ã€`Snapshot` ç­‰å…³é”®å­—ã€‚
* å¯ä»¥å…ˆçœ‹ `qcommon/msg.c` + `net_chan.c`ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯æ‰€æœ‰ç½‘ç»œæ•°æ®çš„åº•å±‚ã€‚

---

## ğŸ”— é™„åŠ èµ„æ–™

* [Quake 3 Networking Model (Gamasutra)](https://www.gamasutra.com/view/feature/131503/1500_archers_on_a_28_8_network.php)
* [Quake 3 Source code on GitHub (ioquake3)](https://github.com/ioquake/ioq3)
* [Fabiensanglard's Quake 3 Code Review](https://fabiensanglard.net/quake3/index.php)ï¼ˆå¼ºçƒˆæ¨èï¼‰
* [Q3 Networking Source Analysis â€“ by Jay Little](https://trac.bookofhook.com/bookofhook/trac.cgi/wiki/Quake3Networking)

---

å¥½ğŸ‘Œï¼Œæˆ‘æ¥å¸®ä½ åšä¸€ä¸ª **å‡½æ•°è°ƒç”¨å…³ç³»å›¾** + **é˜…è¯»è·¯çº¿è¡¨**ï¼Œå¹¶ä¸”æ˜¯ **æ•´ä½“ç½‘ç»œéƒ¨åˆ†** çš„ï¼ˆä¸æ˜¯åªå®¢æˆ·ç«¯æˆ–åªæœåŠ¡å™¨ï¼‰ã€‚è¿™æ ·ä½ èƒ½å¿«é€Ÿå»ºç«‹å…¨å±€çš„ mental modelï¼Œç„¶åå†é€å±‚é’»è¿›å»çœ‹æºç ã€‚

---

# ğŸ•¸ï¸ Quake3 ç½‘ç»œéƒ¨åˆ†å‡½æ•°è°ƒç”¨å…³ç³»å›¾ï¼ˆæ•´ä½“ï¼‰

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚        Client Side         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ CL_WritePacket (cl_main.c)        â”‚ â† å®¢æˆ·ç«¯æŠŠ usercmd æ‰“åŒ…
           â”‚   â””â”€ MSG_WriteDeltaUsercmd (msg.c)â”‚ â† å‹ç¼©è¾“å…¥æŒ‡ä»¤
           â”‚   â””â”€ Netchan_Transmit (net_chan.c)â”‚ â† é€šè¿‡ netchan å‘åŒ…
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UDP (net_udp.c) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                           â”‚
                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ SV_PacketEvent (sv_main.c)       â”‚ â† æœåŠ¡å™¨æ”¶åˆ° UDP åŒ…
           â”‚   â””â”€ Netchan_Process (net_chan.c)â”‚ â† è§£ç å¯é /ä¸å¯é æµ
           â”‚   â””â”€ SV_ExecuteClientMessage     â”‚ â† è§£æ usercmd
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         (æœåŠ¡å™¨æ¨¡æ‹Ÿä¸–ç•Œ â†’ æ›´æ–° world state)
                           â”‚
                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ SV_SendClientSnapshot (sv_snapshot.c) â”‚
           â”‚   â””â”€ SV_BuildClientSnapshot       â”‚ â† ç”Ÿæˆè¯¥ç©å®¶è§†è§’å¿«ç…§
           â”‚   â””â”€ MSG_WriteDeltaEntity (msg.c) â”‚ â† å‹ç¼©å®ä½“çŠ¶æ€
           â”‚   â””â”€ Netchan_Transmit (net_chan.c)â”‚ â† é€šè¿‡ netchan å‘å›
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UDP (net_udp.c) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                           â”‚
                           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ CL_ReadPackets (cl_parse.c)      â”‚ â† å®¢æˆ·ç«¯æ”¶åˆ°å¿«ç…§
           â”‚   â””â”€ Netchan_Process (net_chan.c)â”‚ â† è§£ç åŒ…
           â”‚   â””â”€ CL_ParseSnapshot            â”‚ â† è§£æå¿«ç…§å†…å®¹
           â”‚   â””â”€ CL_PredictMovement          â”‚ â† æœ¬åœ°é¢„æµ‹ + æ’å€¼ä¿®æ­£
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ“‘ é˜…è¯»è·¯çº¿è¡¨ï¼ˆæ•´ä½“ç½‘ç»œéƒ¨åˆ†ï¼‰

æˆ‘æŠŠå®ƒæ‹†æˆ **é˜¶æ®µ**ï¼Œä½ å¯ä»¥æŒ‰ç…§è¿™ä¸ªé¡ºåºé€å±‚é˜…è¯»ï¼Œæ•ˆæœæœ€å¥½ã€‚

| é˜¶æ®µ | æ–‡ä»¶                        | å…³é”®å‡½æ•°                                                    | å…³æ³¨ç‚¹                    | å»ºè®®                              |
| -- | ------------------------- | ------------------------------------------------------- | ---------------------- | ------------------------------- |
| 1  | `net_udp.c`               | `NET_SendPacket`, `NET_GetPacket`                       | UDP åŸºç¡€æ”¶å‘               | å¿«é€Ÿæ‰«ä¸€éï¼ŒçŸ¥é“åœ¨å“ªé‡Œè°ƒç”¨å°±è¡Œ                 |
| 2  | `net_chan.c`              | `netchan_t`, `Netchan_Transmit`, `Netchan_Process`      | UDP ä¸Šå®ç°å¯é /åˆ†ç‰‡/é‡ä¼         | è¿™æ˜¯æ ¸å¿ƒï¼Œå»ºè®®ç»†çœ‹ä»£ç é€»è¾‘                   |
| 3  | `msg.c`                   | `MSG_WriteBits`, `MSG_ReadBits`, `MSG_WriteDeltaEntity` | Bitstream ç¼–è§£ç ï¼Œdelta å‹ç¼© | å»ºè®®çœ‹å‡ ä¸ªå†™/è¯»å‡½æ•°å¯¹ç…§ç†è§£                  |
| 4  | `sv_snapshot.c`           | `SV_SendClientSnapshot`, `SV_BuildClientSnapshot`       | æœåŠ¡å™¨ç”Ÿæˆå¿«ç…§                | çœ‹ entity æ˜¯æ€ä¹ˆè¢«ç­›é€‰ã€å‹ç¼©              |
| 5  | `cl_snapshot.c`           | `CL_ParseSnapshot`, `CL_PredictMovement`                | å®¢æˆ·ç«¯å¤„ç†å¿«ç…§ã€é¢„æµ‹ä¿®æ­£           | å»ºè®®è°ƒè¯•ä¸€ä¸‹é¢„æµ‹è¿‡ç¨‹ï¼Œæœ€æœ‰è¶£                  |
| 6  | `sv_main.c` + `cl_main.c` | `SV_PacketEvent`, `CL_WritePacket`                      | ä¸»å¾ªç¯å¦‚ä½•é©±åŠ¨ç½‘ç»œ              | æŠŠ netchan / msg / snapshot ä¸²è”èµ·æ¥ |

---

# ğŸ¯ é˜…è¯»å»ºè®®ï¼ˆæ•´ä½“ï¼‰

* **å…ˆå…¨å±€** â†’ çœ‹ä¸Šé¢è¿™å¼ è°ƒç”¨å›¾ï¼ŒçŸ¥é“è°è°ƒç”¨è°ã€‚
* **å†ç»†èŠ‚** â†’ é‡ç‚¹é’» `netchan.c` + `msg.c`ï¼Œè¿™ä¸¤ä¸ªæ˜¯æ‰€æœ‰é€»è¾‘çš„åŸºçŸ³ã€‚
* **å¯¹æ¯”è§†è§’**

  * **å®¢æˆ·ç«¯é‡ç‚¹**ï¼šé¢„æµ‹ã€æ’å€¼ã€è¯¯å·®ä¿®æ­£
  * **æœåŠ¡å™¨é‡ç‚¹**ï¼šå¿«ç…§ç”Ÿæˆã€å‹ç¼©ä¼ è¾“ã€å·®åˆ†æ›´æ–°
* **åŠ¨æ‰‹æ–¹æ³•**

  * `grep "Netchan_Transmit"` çœ‹åœ¨å“ªäº›åœ°æ–¹è¢«è°ƒç”¨
  * `grep "CL_ParseSnapshot"` è·Ÿè¸ªå®¢æˆ·ç«¯å¿«ç…§è§£æ

---

# ğŸ§  æœ€ç»ˆ takeaway

* Quake3 çš„ç½‘ç»œå°±æ˜¯ï¼š**UDP socket â†’ netchan (å¯é /ä¸å¯é æ··åˆ) â†’ msg (bitstream å‹ç¼©) â†’ å¿«ç…§ç³»ç»Ÿ (delta snapshot) â†’ å®¢æˆ·ç«¯é¢„æµ‹**

å¥½é—®é¢˜ ğŸ‘ã€‚
Quake3 çš„ç½‘ç»œå±‚ç¡®å®æ˜¯ **UDP ä¸Šè‡ªå·±é€ äº†ä¸€ä¸ªå° TCP**ï¼Œè¿™å°±æ˜¯ `netchan_t` çš„èŒè´£ã€‚

æˆ‘å¸®ä½ æ‹†å¼€ï¼š

---

# ğŸš€ Quake3 Netchan åœ¨ UDP ä¸Šå®ç°å¯é ä¼ è¾“çš„æœºåˆ¶

æ–‡ä»¶ï¼š`code/qcommon/net_chan.c`

æ ¸å¿ƒç»“æ„ï¼š

```c
typedef struct {
    qboolean fatal_error; 
    int outgoingSequence;   // å‘é€åºå·
    int incomingSequence;   // æ¥æ”¶åºå·
    int dropped;            // æ‰çš„åŒ…æ•°
    netadr_t remoteAddress; // è¿œç«¯åœ°å€

    int qport;              // ç”¨äºè¯†åˆ«å®¢æˆ·ç«¯
    int fragmentSequence;   // åˆ†ç‰‡åºå·
    int fragmentLength;     // åˆ†ç‰‡é•¿åº¦
    byte fragmentBuffer[MAX_PACKETLEN]; // ç¼“å†²åŒº
} netchan_t;
```

---

## 1ï¸âƒ£ åŸºç¡€ï¼šåºåˆ—å·æœºåˆ¶

* **æ¯ä¸ª UDP åŒ…** éƒ½å¸¦ä¸€ä¸ª `sequence number`ï¼ˆè‡ªå¢ï¼‰ã€‚
* æ¥æ”¶ç«¯ç”¨å®ƒæ¥æ£€æµ‹ï¼š

  * **æ–°åŒ…**ï¼ˆåºå·é€’å¢ï¼‰
  * **ä¸¢åŒ…**ï¼ˆè·³å· â†’ è®°å½• droppedï¼‰
  * **ä¹±åº**ï¼ˆå°äºç­‰äºå½“å‰å·²æ”¶åºå· â†’ ä¸¢å¼ƒï¼‰

ğŸ‘‰ è¿™æ ·ä¿è¯äº†**é¡ºåºæ€§æ£€æµ‹**ï¼Œä½†ä¸æ˜¯è‡ªåŠ¨é‡ä¼ ã€‚

---

## 2ï¸âƒ£ å¯é æ¶ˆæ¯é˜Ÿåˆ—

åœ¨ `netchan` ä¸­æœ‰ä¸€ä¸ª **å¯é æ¶ˆæ¯ç¼“å†²åŒº**ï¼š

* å½“ä½ è°ƒç”¨ `Netchan_Transmit` å‘é€æ•°æ®æ—¶ï¼š

  * ä¸ä»…å‘å½“å‰æ•°æ®åŒ…ï¼Œè¿˜ä¼šé™„å¸¦ä¸Šã€Œä¹‹å‰æ²¡ç¡®è®¤çš„å¯é æ•°æ®ã€ã€‚
  * æ‰€ä»¥å¯é æ¶ˆæ¯ä¼šåå¤ piggyback åœ¨æ–°åŒ…é‡Œï¼Œç›´åˆ°æ”¶åˆ°ç¡®è®¤ã€‚

è¿™å°±æœ‰ç‚¹åƒ TCP çš„ã€Œæ»‘åŠ¨çª—å£ã€ï¼Œä½†å®ç°éå¸¸ç®€åŒ–ã€‚

---

## 3ï¸âƒ£ ACK / ç¡®è®¤æœºåˆ¶

* æ¯ä¸ªåŒ…å¤´åŒ…å«ï¼š

  * æˆ‘æ–¹çš„ `outgoingSequence`
  * æˆ‘æ”¶åˆ°çš„å¯¹æ–¹çš„ `sequence`
* å½“å¯¹æ–¹æ”¶åˆ°åŒ…æ—¶ï¼Œç­‰äºå‘Šè¯‰ä½ ã€Œæˆ‘å·²ç»æ”¶åˆ° up to X çš„æ•°æ®ã€ã€‚
* ç„¶åä½ å°±å¯ä»¥æ¸…é™¤å¯é æ¶ˆæ¯ç¼“å†²åŒºé‡Œ â‰¤X çš„éƒ¨åˆ†ã€‚

ğŸ‘‰ è¿™æ ·å°±å®ç°äº†**ç¡®è®¤ + é‡ä¼ **ã€‚

---

## 4ï¸âƒ£ åˆ†ç‰‡æœºåˆ¶ï¼ˆFragmentationï¼‰

å› ä¸º UDP åŒ…æœ€å¤§é•¿åº¦æœ‰é™ï¼ˆé€šå¸¸ <1400 bytesï¼‰ï¼Œè€Œ Quake3 çš„å¿«ç…§å¯èƒ½æ›´å¤§ï¼ˆå‡ å KBï¼‰ã€‚

æœºåˆ¶ï¼š

* **å¤§åŒ… â†’ æ‹†åˆ†æˆå¤šä¸ª fragment**ï¼š

  * `fragmentSequence`ï¼šåˆ†ç‰‡åºå·
  * `fragmentLength`ï¼šå½“å‰ç‰‡é•¿åº¦
* æ¥æ”¶ç«¯æŠŠå¤šä¸ª fragment æ”¶é›†åˆ° `fragmentBuffer`ï¼Œæ‹¼æˆå®Œæ•´å¤§åŒ…ã€‚
* **åªæœ‰å®Œæ•´æ‹¼èµ·æ¥åæ‰äº¤ç»™ä¸Šå±‚è§£æ**ã€‚

ğŸ‘‰ é¿å…äº† UDP MTU è¶…è¿‡æ—¶çš„ IP å±‚ç¢ç‰‡ä¸¢å¤±é—®é¢˜ã€‚

---

## 5ï¸âƒ£ ä¸å¯é  vs å¯é æ··åˆ

Quake3 åŒºåˆ†ï¼š

* **ä¸å¯é æ¶ˆæ¯**ï¼ˆä½äº `datagram`ï¼‰ï¼šæ¯”å¦‚ç©å®¶çš„æŒ‰é”®è¾“å…¥ï¼Œä¸¢äº†å°±ç®—äº†ï¼Œä¸‹ä¸€ä¸ª tick ä¼šæœ‰æ–°è¾“å…¥ã€‚
* **å¯é æ¶ˆæ¯**ï¼ˆä½äº `reliable buffer`ï¼‰ï¼šæ¯”å¦‚åœ°å›¾åˆ‡æ¢ã€serverCommandï¼Œè¿™äº›å¿…é¡»åˆ°è¾¾ã€‚

ğŸ‘‰ å®ç°æ–¹å¼æ˜¯ï¼š

* æŠŠ **å¯é æ•°æ®** ç¼“å­˜åœ¨ `netchan`ï¼Œç›´åˆ° ACK
* æŠŠ **ä¸å¯é æ•°æ®** ç›´æ¥ä¸¢è¿›å½“å‰åŒ…
* æ¯æ¬¡å‘é€æ–°åŒ…ï¼Œå¯é æ•°æ®éƒ½ä¼š piggyback

---

# ğŸ“Š å°æ€»ç»“ï¼ˆå’Œ TCP å¯¹æ¯”ï¼‰

| ç‰¹æ€§   | TCP    | Quake3 Netchan    |
| ---- | ------ | ----------------- |
| ä¼ è¾“å±‚  | å†…æ ¸å®ç°   | ç”¨æˆ·æ€ UDP           |
| é¡ºåºæ€§  | å†…å»º     | åºåˆ—å·æ£€æµ‹             |
| ä¸¢åŒ…æ¢å¤ | è‡ªåŠ¨é‡ä¼    | piggyback é‡å‘      |
| åˆ†ç‰‡   | IP åˆ†ç‰‡  | åº”ç”¨å±‚åˆ†ç‰‡             |
| æµé‡æ§åˆ¶ | æ»‘åŠ¨çª—å£   | æ— ï¼ˆéå¸¸ç®€å•ï¼‰           |
| é€‚ç”¨åœºæ™¯ | ä»»æ„å¯é ä¼ è¾“ | æ¸¸æˆï¼šå¤§éƒ¨åˆ†ä¸å¯é  + å°éƒ¨åˆ†å¯é  |


